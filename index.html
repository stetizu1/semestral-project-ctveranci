<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8"/>
    <title>Čtveránci</title>
    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="game/gameObjects/map.js"></script>
    <script src="game/gameObjects/player.js"></script>
    <script src="game/gameObjects/playerAI.js"></script>
    <script src="game/gameObjects/bullet.js"></script>
    <script src="game/gameObjects/statusBar.js"></script>
    <script src="game/gameObjects/timer.js"></script>

    <script src="game/states/gameStateManager.js"></script>
    <script src="game/states/menu.js"></script>
    <script src="game/states/game.js"></script>
    <script src="game/states/end.js"></script>

    <script src="game/gameWindow.js"></script>
    <script src="game/keys.js"></script>

    <script src="sharedFunc.js"></script>

</head>

<body>

<header>
    <h1>Čtveránci</h1>
</header>

<nav>
    <div class="navigation">
        <input type=radio name="radioButton" id="introduction" value="#introductionContent"/>
        <input type=radio name="radioButton" id="settings" value="#settingsContent"/>
        <input type=radio name="radioButton" id="game" value="#gameContent"/>
        <input type="radio" name="radioButton" id="leaderBoard" value="#leaderBoardContent">
        <input type="radio" name="radioButton" id="mapEditor" value="#mapEditorContent">

        <label class="menu" for="introduction">Úvod</label>
        <label class="menu" for="settings">Nastavení</label>
        <label class="menu" for="game">Hra</label>
        <label class="menu" for="leaderBoard">Žebříček</label>
        <label class="menu" for="mapEditor">Editor map</label>
    </div>
</nav>

<section id="logoContent">
    <h2>Čtveránci</h2>
    <div id="logo">
        <div id="redSquare"></div>
        <div id="blueSquare"></div>
        <div id="greenSquare"></div>
        <div id="yellowSquare"></div>
    </div>
</section>

<section id="introductionContent">
    <h2>Úvod</h2>

    <article>
        <h3>Inspirace</h3>
        <video controls poster="pictures/bulanek.png">
            <source src="videos/Bulanci trailer.mp4"
                    type="video/mp4"
            />
            <img src="pictures/bulanek.png">
        </video>
    </article>


    <article>
        <h3>Ovládání</h3>
        popis ovládání
    </article>

    <article>
        <h3>Dokumentace</h3>
        Dokumentace projektu <a href="documentation.html">zde</a>.
    </article>


</section>

<section id="settingsContent">
    <h2>Nastavení</h2>
    <form>
        <fieldset>
            <legend> Hráči </legend>
            <input type="radio" name="numPlayerOption" id="onePlayer" value="1" checked>
            <label for="onePlayer"><img src="pictures/person.png" alt="one player game"></label>
            <input type="radio" name="numPlayerOption" id="twoPlayers" value="2">
            <label for="twoPlayers"><img src="pictures/people.png" alt="two players game"></label>

            <br />

            <label for="playerOneName" class="blockLabel">Hráč 1:</label>
            <input type="text" id="playerOneName" placeholder="Player 1" maxlength="10">
            <label for="playerTwoName" class="blockLabel" id="playerTwoNameLabel">Hráč 2:</label>
            <input type="text" id="playerTwoName" placeholder="Player 2" maxlength="10">

        </fieldset>

        <fieldset>
            <legend> Mapa </legend>
            <input type="radio" name="map" id="randomMap" value="true" checked>
            <label for="randomMap"><img src="pictures/dice.svg" alt="random generated map"></label>
            <input type="radio" name="map" id="insertedMap" value="false">
            <label for="insertedMap"><img src="pictures/insert.png" alt="inserted map"></label>

            <div id="mapInsert">Přetáhněte sem soubor s mapou</div>
        </fieldset>

        <fieldset>
            <legend> Čas </legend>
            <label class="blockLabel" for="gameTime">Výběr času hry:</label>
            <div class="styledSelect">
                <select name="time" id="gameTime">
                    <option value="60">60 vteřin</option>
                    <option value="90" selected>90 vteřin</option>
                    <option value="120">120 vteřin</option>
                    <option value="180">180 vteřin</option>
                </select>
            </div>
        </fieldset>
    </form>


</section>
<section id="gameContent">
    <h2>Hra</h2>
</section>

<section id="leaderBoardContent">
    <h2>Žebříček</h2>
</section>

<section id="mapEditorContent">
    <h2>Editor map</h2>

    <input type="radio" name="treeOption" id="tree0" value=0 checked>
    <label class="treeLabel" for="tree0"></label>
    <input type="radio" name="treeOption" id="tree1" value=1>
    <label class="treeLabel" for="tree1"></label>
    <input type="radio" name="treeOption" id="tree2" value=2>
    <label class="treeLabel" for="tree2"></label>
    <input type="radio" name="treeOption" id="tree3" value=3>
    <label class="treeLabel" for="tree3"></label>
    <input type="radio" name="treeOption" id="tree4" value=4>
    <label class="treeLabel" for="tree4"></label>
    <input type="radio" name="treeOption" id="tree5" value=5>
    <label class="treeLabel" for="tree5"></label>
    <input type="radio" name="treeOption" id="tree6" value=6>
    <label class="treeLabel" for="tree6"></label>
    <input type="radio" name="treeOption" id="tree7" value=7>
    <label class="treeLabel" for="tree7"></label>
    <input type="radio" name="treeOption" id="tree8" value=8>
    <label class="treeLabel" for="tree8"></label>

    <br />
    <svg id="svgMap" viewBox="0 0 20 12">
        <!--//#2c8d3d
        <defs>
            <pattern id="pattern" width="0.1" height="0.1667">
                <rect x="0" y="0" width="1" height="1"></rect>
                <rect x="1" y="1" height="1" width="1"></rect>
                <rect x="0" y="1" height="1" width="1"></rect>
                <rect x="1" y="0" height="1" width="1"></rect>

            </pattern>
        </defs>
        <rect fill="url(#pattern)" x="0" y="0" width="100%" height="100%"></rect>
-->
    </svg>
    <form>
        <label for="mapName">Jméno souboru k uložení:</label>
        <input id="mapName" type="text">
        <button id="saveMap">Uložit</button>
    </form>


</section>

<footer>
    Zuzana Štětinová, FEL ČVUT 2018
</footer>

<script>
    //push first site
    history.pushState("#logoContent", "#logoContent");

    //save menu items
    let radios = document.getElementsByName("radioButton");

    //content load due to menu
    for(let i = 0; i < radios.length; i++) {
        radios[i].onclick = () => {
            //prevent from inserting same state
            if(history.state !== radios[i].value) {
                history.pushState(radios[i].value, radios[i].value);
            }

            //show selected section
            let state = radios[i].value;
            setState(state);
        }
    }
    window.addEventListener("popstate", (event) =>{
        setState(event.state);
        if(event.state === "#logoContent"){
            let radiosToUncheck = document.getElementsByName("radioButton");
            for(let i = 0; i < radios.length; i++) {
                radiosToUncheck[i].checked = false;
            }
            return;
        }
        let menuId = event.state.replace("Content", "");
        const currentMenuOption = document.querySelector(menuId);
        currentMenuOption.checked = true;
    });

    //Drag and drop for inserting map
    let dragAndDrop = document.getElementById("mapInsert");

    dragAndDrop.addEventListener("dragover", (event) => {
        event.preventDefault();
    });

    dragAndDrop.addEventListener("dragenter", () => {
        dragAndDrop.style.opacity = 1;
        dragAndDrop.style.border = "3px solid red";
    });

    dragAndDrop.addEventListener("dragleave", () => {
        dragAndDrop.style.opacity = 0.8;
        dragAndDrop.style.border = "3px solid transparent";
    });

    dragAndDrop.addEventListener("drop", (event) => {
        event.preventDefault();
        dragAndDrop.style.border = "3px solid transparent";

        const FILES = Array.from(event.dataTransfer.files);
        let file = FILES.length > 0 ? FILES[0] : null;
        let fr = new FileReader();

        fr.addEventListener("load", function(e) {
            try {
                map = JSON.parse(e.target.result);
                dragAndDrop.innerHTML=file.name;
            }
            catch (e){
                map = null;
                alert(e);
            }
        });

        if(file !== null){
            fr.readAsText(file);
        }
    });

    let svg = document.querySelector("#svgMap");
    const ROWS = 12;
    const COLUMNS = 20;
    let createdMap = [];

    //create default map
    for (let i = 0; i < ROWS; i++) {
        let line = [];
        for (let j = 0; j < COLUMNS; j++) {
            line.push(-2);

        }
        createdMap.push(line);
    }

    //create svgMap
    const svgNS = "http://www.w3.org/2000/svg";

    for (let i = 0; i < ROWS; i++) {
        for (let j = 0; j < COLUMNS; j++) {
        //<rect x="0" y="0" width="1" height="1"></rect>
            let rect = document.createElementNS(svgNS, 'rect');
            rect.setAttributeNS('', 'x', '' + j);
            rect.setAttributeNS('', 'y', '' + i);
            rect.setAttributeNS('', 'height', '1');
            rect.setAttributeNS('', 'width', '1');

            let color = "";
            if (i % 2 === 0) {
                if (j % 2 === 0) color = "#2a7f35";
                else color = "#2c8d3d";
            } else {
                if (j % 2 === 0) color = "#2c8d3d";
                else color = "#2a7f35";
            }
            rect.setAttributeNS('', 'fill', color);

            if (i !== ROWS - 1 && j !== COLUMNS -1) {
                rect.addEventListener("click", () => {

                    let line = parseInt(rect.getAttribute("y"));
                    let col = parseInt(rect.getAttribute("x"));

                    //already tree there
                    if(createdMap[line][col] !== -2 ||
                        createdMap[line + 1][col] !== -2 ||
                        createdMap[line][col + 1] !== -2 ||
                        createdMap[line + 1][col + 1] !== -2
                    ) return;

                    let treeNumber = 0;
                    let treesRadioButtons = document.getElementsByName("treeOption");
                    for(let i = 0; i < 9; i++){
                        if (treesRadioButtons[i].checked) treeNumber = parseInt(treesRadioButtons[i].value);
                    }

                    createdMap[line][col] = treeNumber;
                    createdMap[line + 1][col] = treeNumber;
                    createdMap[line][col + 1] = treeNumber;
                    createdMap[line + 1][col + 1] = treeNumber;

                    let g = document.createElementNS(svgNS, 'g');

                    let circle = document.createElementNS(svgNS, 'circle');
                    circle.setAttributeNS('', 'cx', (col+1) + '');
                    circle.setAttributeNS('', 'cy', (line+1) + '');
                    circle.setAttributeNS('', 'r', '1');
                    circle.setAttributeNS('', 'fill', '#8d0002');

                    let text = document.createElementNS(svgNS, 'text');
                    text.setAttributeNS('', 'x', (col+1) + '');
                    text.setAttributeNS('', 'y', (line+1.15) + '');
                    text.setAttributeNS('', 'font-family', 'Verdana');
                    text.setAttributeNS('', 'font-size', '0.5');
                    text.setAttributeNS('', 'text-anchor', 'middle');
                    text.setAttributeNS('', 'fill', '#FFFFFF');
                    text.innerHTML = treeNumber;

                    g.addEventListener("click", () =>{
                        let l = parseInt(circle.getAttribute("cy")) - 1;
                        let c = parseInt(circle.getAttribute("cx")) - 1;
                        createdMap[l][c] = -2;
                        createdMap[l + 1][c] = -2;
                        createdMap[l][c + 1] = -2;
                        createdMap[l + 1][c + 1] = -2;
                        svg.removeChild(g);
                        console.log(createdMap);
                    });

                    g.appendChild(circle);
                    g.appendChild(text);

                    svg.appendChild(g)

                });
            }
            svg.appendChild(rect);
        }
    }

    document.querySelector("#saveMap").addEventListener("click", () => {
        let mapField = JSON.stringify(createdMap);
        let mapName = document.querySelector("#mapName").value + ".map";
        if(mapName.length === 0){
            mapName = "map";
        }
        download(mapName, mapField);
    });

    function download(filename, text) {
        let element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }



</script>

</body>
</html>